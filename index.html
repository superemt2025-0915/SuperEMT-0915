<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>æ•‘è­·ç¾©æ¶ˆæ´»å‹•çœ‹æ¿ï¼ˆå…å¾Œç«¯äº’å‹•ç‰ˆï¼‰</title>
  <style>
    :root{
      --ems-red:#d7263d; --ems-blue:#1b3b6f; --bg:#f7f8fb; --text:#1a1a1a;
      --muted:#6b7280; --card:#fff; --chip:#eef2ff; --ok:#166534;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial}
    .topbar{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;justify-content:space-between;
      padding:12px 16px;background:linear-gradient(90deg,var(--ems-blue),var(--ems-red));color:#fff}
    .topbar h1{margin:0;font-size:18px}
    .topbar button{background:#fff;color:var(--ems-blue);border:none;border-radius:6px;padding:8px 12px;cursor:pointer}
    .container{max-width:1200px;margin:16px auto;padding:0 12px}
    .board{display:grid;grid-template-columns:1.2fr 1.8fr;gap:16px}
    .calendar-wrap iframe{width:100%;min-height:600px;border:0;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.06)}
    .events-wrap .toolbar{display:flex;gap:8px;margin-bottom:8px}
    .toolbar input{flex:1;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px}
    .events{display:grid;gap:12px}
    .event{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .event h3{margin:0 0 6px 0}
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
    .chip{background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button.primary{background:var(--ems-red);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    button.secondary{background:var(--ems-blue);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    button.ghost{background:#fff;color:var(--ems-blue);border:1px solid var(--ems-blue);border-radius:8px;padding:8px 12px;cursor:pointer}
    .album{margin-top:10px;overflow:hidden;border-radius:10px;border:1px solid #e5e7eb}
    .album iframe{width:100%;height:320px;border:0}
    .muted{color:var(--muted);font-size:12px}
    dialog{border:none;border-radius:12px;padding:16px;max-width:520px;width:92%}
    dialog form{display:grid;gap:8px}
    dialog label{display:grid;gap:4px;font-size:14px}
    dialog menu{display:flex;justify-content:flex-end;gap:8px;margin:8px 0 0 0;padding:0}
    .foot{padding:24px 0;text-align:center;color:var(--muted)}
    @media (max-width:980px){
      .board{grid-template-columns:1fr}
      .calendar-wrap iframe{min-height:520px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <h1>ğŸš‘ æ•‘è­·ç¾©æ¶ˆæ´»å‹•çœ‹æ¿</h1>
    <div class="right">
      <button id="openAdmin">å¹¹éƒ¨ç®¡ç†</button>
    </div>
  </header>

  <main class="container">
    <section class="board">
      <!-- å·¦ï¼šGoogle æ—¥æ›†ï¼ˆä½ çš„å…¬é–‹åµŒå…¥ç¶²å€ï¼‰ -->
      <div class="calendar-wrap">
        <iframe
          src="https://calendar.google.com/calendar/embed?src=1b934187b542a739c0faed74834f8175288bb33c0d1ca25f5b4a5cf1104c728d%40group.calendar.google.com&ctz=Asia%2FTaipei"
          frameborder="0" scrolling="no"></iframe>
      </div>

      <!-- å³ï¼šæ´»å‹•æ¸…å–®ï¼ˆå…å¾Œç«¯äº’å‹•ï¼Œå­˜ localStorageï¼‰ -->
      <div class="events-wrap">
        <div class="toolbar">
          <input id="q" placeholder="æœå°‹æ´»å‹•ï¼ˆæ¨™é¡Œ/åœ°é»ï¼‰"/>
          <button id="reloadBtn" type="button">é‡æ–°è¼‰å…¥</button>
        </div>
        <div id="eventsList" class="events"></div>
      </div>
    </section>
  </main>

  <!-- å ±å Modal -->
  <dialog id="signupDlg">
    <form method="dialog" id="signupForm">
      <h3>æ´»å‹•å ±å</h3>
      <p id="signupEventTitle" class="muted"></p>
      <label>åˆ†éšŠ <input name="division" required></label>
      <label>å§“å <input name="name" required></label>
      <label>äººæ•¸ <input name="count" type="number" min="1" step="1" value="1" required></label>
      <menu>
        <button value="cancel">å–æ¶ˆ</button>
        <button id="signupSubmit" value="default">é€å‡º</button>
      </menu>
    </form>
    <p id="signupResult" class="muted"></p>
  </dialog>

  <!-- å–æ¶ˆ Modal -->
  <dialog id="cancelDlg">
    <form method="dialog" id="cancelForm">
      <h3>å–æ¶ˆå ±å</h3>
      <p id="cancelEventTitle" class="muted"></p>
      <label>å–æ¶ˆåŸå›  <input name="reason" required></label>
      <menu>
        <button value="cancel">é—œé–‰</button>
        <button id="cancelSubmit" value="default">ç¢ºèªå–æ¶ˆ</button>
      </menu>
    </form>
    <p id="cancelResult" class="muted"></p>
  </dialog>

  <!-- å¹¹éƒ¨å¾Œå°ï¼ˆæœ¬æ©Ÿï¼‰ -->
  <dialog id="adminDlg">
    <form method="dialog" id="adminForm">
      <h3>å¹¹éƒ¨ç®¡ç†ï¼ˆæœ¬æ©Ÿé è¦½ï¼‰</h3>
      <label>å‹•ä½œ
        <select name="action" required>
          <option value="create_event">æ–°å¢æ´»å‹•</option>
          <option value="update_event">ä¿®æ”¹æ´»å‹•</option>
          <option value="delete_event">åˆªé™¤æ´»å‹•(è»Ÿåˆªé™¤)</option>
        </select>
      </label>
      <label>æ´»å‹•IDï¼ˆä¿®æ”¹/åˆªé™¤å¿…å¡«ï¼‰<input name="id" placeholder="E_xxx"></label>
      <label>æ¨™é¡Œ <input name="title" placeholder="ä¾‹å¦‚ï¼šå¤œé–“å€¼å‹¤æ¼”ç·´"></label>
      <label>æ—¥æœŸ <input name="date" type="date"></label>
      <label>é–‹å§‹æ™‚é–“ <input name="start_time" type="time"></label>
      <label>çµæŸæ™‚é–“ <input name="end_time" type="time"></label>
      <label>åœ°é» <input name="location" placeholder="åˆ†éšŠ/æ“å ´/æœƒè­°å®¤"></label>
      <label>èªªæ˜ <textarea name="description" rows="3" placeholder="å¿…è¦è£å‚™ã€æœè£â€¦"></textarea></label>
      <label>ç›¸ç°¿åµŒå…¥é€£çµ <input name="album_url" placeholder="Google Photos/Drive/Imgur ç­‰åµŒå…¥é€£çµ"></label>
      <label>ä¸Šæ¶ï¼ˆtrue/falseï¼‰<input name="is_active" placeholder="true"></label>
      <menu>
        <button value="cancel">é—œé–‰</button>
        <button id="adminSubmit" value="default">é€å‡º</button>
      </menu>
    </form>
    <p class="muted">ï¼Šæ­¤ç‰ˆæœ¬åƒ…å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚</p>
    <p id="adminResult" class="muted"></p>
  </dialog>

  <footer class="foot">
    <small>å…å¾Œç«¯äº’å‹•ç‰ˆ â€¢ å–®é å¼ â€¢ ä½ çš„è£ç½®æœƒè¨˜ä½å ±åèˆ‡å–æ¶ˆ</small>
  </footer>

  <script>
    // ---- åˆå§‹è³‡æ–™ï¼ˆå¯è‡ªè¡Œæ”¹ï¼‰----
    const demoAlbum = "https://drive.google.com/embeddedfolderview?id=1kiTnPZNlvPM_L9H6KlDd_UDEz6miryg3#grid";
    const DEFAULT_EVENTS = [
      { id:'E_20250919', title:'å¢èƒ½è‡ªä¸»è¨“ç·´æš¨çƒ¤è‚‰', date:'2025-09-19', start_time:'18:00', end_time:'21:00', location:'å¾Œé¾åˆ†éšŠ', description:'1. è‡ªä¸»è¨“ç·´\\n2. ä¸­ç§‹ç¯€çƒ¤è‚‰\\n3. å®¢æ¶ˆå­¸å“¡è¯èª¼\\n4. æ”¯æ´æœ¬æ¬¡æ´»å‹•', album_url: demoAlbum, is_active:true, signed_count:0 }
    ];

    // ---- ç‹€æ…‹ï¼ˆlocalStorageï¼‰----
    const state = { events: loadEvents(), mySignups: loadSignups() };

    // UI ç¶å®š
    document.getElementById('openAdmin').onclick = ()=>document.getElementById('adminDlg').showModal();
    document.getElementById('reloadBtn').onclick = render;
    document.getElementById('q').addEventListener('input', render);
    document.getElementById('signupForm').addEventListener('submit', onSignupSubmit);
    document.getElementById('cancelForm').addEventListener('submit', onCancelSubmit);
    document.getElementById('adminForm').addEventListener('submit', onAdminSubmit);

    // åˆå§‹æ¸²æŸ“
    render();

    function render(){
      const q = (document.getElementById('q').value||'').trim().toLowerCase();
      const list = document.getElementById('eventsList');
      list.innerHTML = '';
      const filtered = state.events.filter(e => e.is_active!==false)
        .filter(e => !q || (e.title+ ' '+ e.location + ' '+ e.description).toLowerCase().includes(q));
      if (!filtered.length){ list.innerHTML = '<p class="muted">ç›®å‰æ²’æœ‰æ´»å‹•ã€‚</p>'; return; }
      for (const ev of filtered){
        const mine = state.mySignups[ev.id];
        const timeStr = [formatDate(ev.date), timeRange(ev)].filter(Boolean).join(' ');
        const card = document.createElement('div'); card.className='event';
        card.innerHTML = `
          <h3>${esc(ev.title)}</h3>
          <div class="meta">
            <span class="chip">ğŸ—“ï¸ ${timeStr}</span>
            ${ev.location? `<span class="chip">ğŸ“ ${esc(ev.location)}</span>`:''}
            <span class="chip">ğŸ‘¥ å·²å ± ${ev.signed_count||0} äºº</span>
          </div>
          ${ev.description? `<p style="white-space:pre-line">${esc(ev.description)}</p>`:''}
          <div class="actions">
            ${mine
              ? <button class="ghost" data-act="open-cancel" data-id="${ev.id}">å–æ¶ˆå ±åï¼ˆå·²å ± ${mine.count} äººï¼‰</button>
              : `<button class="primary" data-act="open-signup" data-id="${ev.id}">æˆ‘è¦åƒåŠ </button>`}
            ${ev.album_url? `<button class="secondary" data-act="toggle-album" data-id="${ev.id}">ç›¸ç°¿/ç¾å ´</button>`:''}
          </div>
          ${ev.album_url? `<div class="album" id="album-${ev.id}" style="display:none"><iframe src="${ev.album_url}"></iframe></div>`:''}
          <p class="muted">æ´»å‹•IDï¼š${ev.id}</p>
        `;
        card.addEventListener('click', onCardAction);
        list.appendChild(card);
      }
    }

    function onCardAction(e){
      const btn = e.target.closest('[data-act]');
      if(!btn) return;
      const act = btn.dataset.act, id = btn.dataset.id;
      const ev = state.events.find(x=>x.id===id);
      if(!ev) return;
      if(act==='toggle-album'){
        const el = document.getElementById('album-'+id);
        el.style.display = (el.style.display==='none'||!el.style.display)?'block':'none';
      }
      if(act==='open-signup') openSignup(ev);
      if(act==='open-cancel') openCancel(ev);
    }

    // å ±å/å–æ¶ˆ
    let currentEvent = null;
    function openSignup(ev){
      currentEvent = ev;
      document.getElementById('signupEventTitle').textContent = `${ev.title}ï¼ˆ${formatDate(ev.date)}ï¼‰`;
      document.getElementById('signupResult').textContent = '';
      document.getElementById('signupForm').reset();
      document.getElementById('signupDlg').showModal();
    }
    function onSignupSubmit(e){
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.currentTarget));
      const n = Math.max(1, Number(data.count||1));
      // å­˜æˆ‘çš„å ±å
      state.mySignups[currentEvent.id] = { division:data.division, name:data.name, count:n, when: Date.now() };
      saveSignups(state.mySignups);
      // æ›´æ–°ç¸½äºº
